function btMinimize(){jQuery("#bTranslateContainer").css("display","none")}
function btTranslate(inputEl,parentEl,useSelection,sourceLang,targetLang){if(!inputEl){inputEl=document.activeElement}
if(!parentEl){parentEl=jQuery("#wpadminbar")}
if(!useSelection){useSelection=!0}
if(!sourceLang){sourceLang='auto'}
if(!targetLang){targetLang=document.documentElement.lang}
if('string'===typeof(inputEl)){inputEl=jQuery("#"+inputEl)}
var sourceText=btGetSelected(inputEl);if('object'===typeof(sourceText)){sourceText=sourceText.toString()}
if(!(sourceText)){sourceText='please select some text before translating'}
return btGoogleGet(parentEl,sourceText,sourceLang,targetLang)}
function btnTranslatebbp(el){messageParent=el.parents('li');if(messageParent){messageDetail=messageParent.find('.bbp-reply-content');if((messageDetail)&&(messageDetail.length>0)){el=messageDetail[0]}else{el=messageParent[0]}
return btTranslate(el,messageParent)}else{el=document.activeElement;return btTranslate(el)}}
function btnTranslateMessage(el){messageParent=el.parents('div.message-box');if(messageParent){messageDetail=messageParent.find('textarea');if((messageDetail)&&(messageDetail.length>0)){el=messageDetail[0]}else{messageDetail=messageParent.children('div.message-content');if((messageDetail)&&(messageDetail.length>0)){el=messageDetail[0]}else{el=messageParent[0]}}
return btTranslate(el,messageParent)}else{el=document.activeElement;return btTranslate(el)}}
function btnTranslateActivity(el){activityParent=el.parents('div.activity-content');if(activityParent){activityDetail=activityParent.children('div.activity-inner');if(!(activityDetail)||(activityDetail.length===0)){activityDetail=activityParent.children('div.activity-header')}
if(activityDetail){el=activityDetail[0]}
else{el=activityParent[0]}
return btTranslate(el,activityParent)}
else{el=document.activeElement;return btTranslate(el)}}
function btGetSelected(el,w,d,cstack){if(!el){el=document.activeElement}
if(!w){w=window}
if(!d){d=document}
if(!cstack){cstack=0}
var t='';if(w.getSelection){t=w.getSelection()}else if(d.getSelection){t=d.getSelection()}else if(d.selection){t=d.selection.createRange().text}
if('object'===typeof(t)){t=t.toString()}
if(!t|| ''===t){if(el){switch(el.tagName.toUpperCase()){case "":return '';case "HTML":return '';case "BODY":return '';case "INPUT":return el.value;case "TEXTAREA":return el.value;case "IFRAME":if(cstack<2){t=btGetSelected(el,el.contentWindow,el.contentDocument,cstack+1);if(!t|| ''===t){innerEl=el.contentDocument.activeElement;if(innerEl){t=innerEl.innerText}
else{t=el.contentDocument.body.innerText}}}
return t;default:t=el.innerText}}}
return t}
function btExtractText(str){var ret="";if(/"/.test(str)){matchResult=str.match(/"(.*?)"/g);if(matchResult.length<3){ret+=matchResult[0]}else{for(i=0;i<matchResult.length-3;i=i+2){sResult=matchResult[i].replace(/(^")|("$)/g,'').trim();if((sResult==='\n')||(sResult==='\r')){}else{ret+=sResult}}}}else{if('object'===typeof(t)){t=t.toString()}else{ret=str}}
return ret}
function btGoogleGet(parentEl,q,sourceLang,targetLang){if(!parentEl){parentEl=jQuery("#wpadminbar")}
if(!q){q='please select text to translate'}
if(!sourceLang){sourceLang='auto'}
if(!targetLang){targetLang=document.documentElement.lang}
startSpinner();var url="https://translate.googleapis.com/translate_a/single?client=gtx&sl="+sourceLang+"&tl="+targetLang+"&dt=t&q="+encodeURI(q);var href="http://translate.google.cn/#"+mapGoogleLanguageCode(sourceLang)+'/'+mapGoogleLanguageCode(targetLang)+'/'+encodeURI(q);jQuery('#bTranslateLink').attr('href',href);var msBeforeAjaxCall=new Date().getTime();jQuery.ajax(url,{"type":"GET","timeout":9000}).done(function(data,textStatus,jqXHR){translateResult=btExtractText(data)}).fail(function(jqXHR,textStatus,errorThrown){var translateResult='';switch(textStatus){case "parsererror":break;case "timeout":translateResult='Translation timed out.\n';break;default:translateResult=' Failed on: '+textStatus+'\n'}
if("timeout"!==textStatus){translateResult+=btExtractText(jqXHR.responseText)}
var element=jQuery('#bTranslateResult');element.text(translateResult);element.html(element.text().replace(/\\n\\n/g,'<br />').replace(/\\n/g,'<br />'));element=jQuery('#bTranslateContainer').detach();parentEl.append(element);element.css("display","block")}).always(function(jqXHR,textStatus,errorThrown){stopSpinner()});return!0}
function startSpinner(){jQuery('#translate-icon').addClass('spinner')}
function stopSpinner(){jQuery('#translate-icon').removeClass('spinner')}
function mapGoogleLanguageCode(language){if(!language){language='auto'}
switch(language){case "auto":case "zh-TW":case "zh-CN":return language;default:if(language.length>2){return language.substr(0,2)}
else{return language}}}
jQuery(document).ready(function($){$("#wp-admin-bar-jm-buddy-translate").mousedown(function(){btTranslate()})})